---
title: "Auswertungen für Fragebogen LHS"
output: html_notebook
---

## Aussage 1:
Die Verwaltungsausgaben von fusionierten Gemeinden sind pro Kopf in den ersten drei Jahren nach der Zusammenlegung deutlich gestiegen.
### Frage:
Gilt diese Aussage noch immer, wenn man die Einwohnerzahl im Jahr 2010 fixiert? Welche Veränderungen ergeben sich durch die neuen Annahmen.

```{r}

library(kableExtra)

verwaltungsausgaben_einwohner2010 <- verwaltungsausgaben %>%
  left_join(verwaltungsausgaben %>%
              filter(fj==2010) %>%
              select(gkz_neu, ew) %>%
              rename(ew2010=ew) %>%
              group_by(gkz_neu) %>%
              filter(row_number()==1),
            by='gkz_neu') %>%
  select(gkz_neu, fj, ew, ew2010, everything())

verwaltungsausgaben_einwohner2010_progemeinde <- verwaltungsausgabenprokopf_einwohner2010 %>%
  group_by(fj, gsrbetr, gkz_neu) %>% 
  summarise(vwausgaben=sum(vwausgaben), ew2010=first(ew2010))

verwaltungsausgaben_einwohner2010_gesamt <- verwaltungsausgaben_einwohner2010_progemeinde %>%
  group_by(fj,gsrbetr) %>%
  summarise(vwausgabenprokopf=sum(vwausgaben)/sum(ew2010))

plot_einwohner2010 <- ggplot(verwaltungsausgaben_einwohner2010_gesamt, aes(fj, vwausgabenprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum() +
  ggtitle("VWA/Kopf Einwohnerzahl fix 2010")
  #theme(legend.position="none")+
  #geom_dl(aes(label = gsrbetr), method="angled.boxes")+plot(plot7)

plot(plot_einwohner2010)

verwaltungsausgaben_einwohner2010_gesamt_ohnegraz <- verwaltungsausgaben_einwohner2010_progemeinde %>%
  filter(gkz_neu!=60101) %>%
  group_by(fj,gsrbetr) %>%
  summarise(vwausgabenprokopf=sum(vwausgaben)/sum(ew2010))

plot_einwohner2010_ohnegraz <- ggplot(verwaltungsausgaben_einwohner2010_gesamt_ohnegraz, aes(fj, vwausgabenprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum() +
  ggtitle("VWA/Kopf Einwohnerzahl fix 2010 ohne Graz")
  #theme(legend.position="none")+
  #geom_dl(aes(label = gsrbetr), method="angled.boxes")+plot(plot7)

plot(plot_einwohner2010_ohnegraz)
```

Antwort: eine deutliche Steigerung der Verwaltungsausgaben pro Kopf ist auch zu sehen, wenn die Einwohnerzahlen auf Stand 2010 fixiert werden.

## Aussage 2:
Im Detail sprangen die Verwaltungsausgaben pro Kopf vom Jahr 2014 auf 2015 von 537 Euro auf 603. Das sind um 12 Prozent mehr.
### Frage:
Welche Verwaltungsausgaben der fusionierten Gemeinden ergeben sich pro Kopf für die einzelnen Jahre, wenn man die Einwohnerzahl im Jahr 2010 fixiert?

```{r}
verwaltungsausgaben_einwohner2010_gesamt %>%
  ungroup() %>%
  spread(fj, vwausgabenprokopf) %>%
  bind_rows(
    verwaltungsausgaben_einwohner2010_gesamt %>% ungroup() %>% left_join(verwaltungsausgaben_einwohner2010_gesamt %>%
                                                                           ungroup() %>%
                                                             mutate(fjnext=fj+1) %>%
                                                             rename(vwausgabenprokopflast=vwausgabenprokopf) %>%
                                                             select(-fj),
                                                           by=c('fj'='fjnext', 'gsrbetr'='gsrbetr')
                                                           ) %>%
      mutate(steigerung=(vwausgabenprokopf/vwausgabenprokopflast-1)*100) %>%
      mutate(gsrbetr = paste(gsrbetr, "Steigerung")) %>%
      select(-vwausgabenprokopf,-vwausgabenprokopflast) %>%
      spread(fj,steigerung)
  ) %>%
  kable(caption="Verwaltungsausgaben/Kopf Einwohner2010",
        digits=1,
        format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_styling()
```

## Aussage 3:
Im gleichen Jahr (2015) sind die Kosten bei nicht-fusionierten Gemeinden um 1,6 Prozent gefallen: auf 556 Euro.
## Aussage 4:
Auch vom Jahr 2016 auf 2017 sind die Verwaltungsausgaben pro Kopf in fusionierten Gemeinden stärker gestiegen (+1,5 %) als in nicht fusionierten (+0,8 %).
### Frage:
Wie stellen sich diese Zahlen dar, wenn man die „nicht-fusionierten Gemeinden“ ohne Graz rechnet und wie, wenn man zusätzlich noch die Zahlen im Jahr 2010 „fixiert“?

```{r}
verwaltungsausgaben_einwohner2010_gesamt_ohnegraz %>%
  ungroup() %>%
  spread(fj, vwausgabenprokopf) %>%
  bind_rows(
    verwaltungsausgaben_einwohner2010_gesamt_ohnegraz %>% ungroup() %>% left_join(verwaltungsausgaben_einwohner2010_gesamt_ohnegraz %>%
                                                                           ungroup() %>%
                                                             mutate(fjnext=fj+1) %>%
                                                             rename(vwausgabenprokopflast=vwausgabenprokopf) %>%
                                                             select(-fj),
                                                           by=c('fj'='fjnext', 'gsrbetr'='gsrbetr')
                                                           ) %>%
      mutate(steigerung=(vwausgabenprokopf/vwausgabenprokopflast-1)*100) %>%
      mutate(gsrbetr = paste(gsrbetr, "Steigerung")) %>%
      select(-vwausgabenprokopf,-vwausgabenprokopflast) %>%
      spread(fj,steigerung)
  ) %>%
  kable(caption="Verwaltungsausgaben/Kopf Einwohner2010 ohne Graz",
        digits=1,
        format.args = list(decimal.mark = ',', big.mark = ".")) %>%
  kable_styling()
```

Hier ändert sich eine Aussage leicht: bei Nichtbeachtung von Graz liegt die Steigerung der Verwaltungskosten 2017 bei fusionierten und nichtfusionierten auf dem gleichen Niveau (+1,7% vs +1,9%).

## Diagramm: „Verwaltungsausgaben in fusionierten Gemeinden über dem Niveau der Reform“
### Frage:
Wie würde sich das Diagramm ändern, wenn man die Zahlen für Graz aus der Berechnung herausnimmt und die Einwohnerzahlen auf dem Niveau des Jahres 2010 fixiert?

_Siehe Antwort auf Frage 1_
 
## Diagramm: „Bei welchen Kostenstellen die Ausgaben gestiegen sind“
### Frage:
Wie würden sich die Zahlen in diesem Diagramm ändern, wenn man die Zahlen für Graz aus der Berechnung herausnimmt und die Einwohnerzahlen auf dem Niveau des Jahres 2010 fixiert?

```{r}
posten_data_ew2010 <- posten_data %>%
  left_join(posten_data %>%
              filter(fj==2010) %>%
              group_by(gkz_neu) %>%
              filter(row_number()==1) %>%
              rename(ew2010=ew) %>%
              select(gkz_neu, ew2010))

posten_gruppen <- c("Personal", "Energie")
ansaetze_gruppen <- c("gemeindereferate", "Freiwillige Feuerwehren", "Gewaehlte Gemeindeorgane", "Wirtschaftshoefe (Bauhof)", "Fuhrpark")

posten_gemeinden_gruppen <- posten_data_ew2010 %>%
  filter(gruppe %in% posten_gruppen) %>%
  filter (hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(gruppenausgabenprokopf = sum(soll)/first(ew))

posten_gemeinden_gruppen_ew2010 <- posten_data_ew2010 %>%
  filter(gruppe %in% posten_gruppen) %>%
  filter (hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew2010) %>%
  summarise(gruppenausgabenprokopf = sum(soll)/first(ew2010))

ansaetze_data_ew2010 <- ansaetze_data %>%
  left_join(posten_data %>%
              filter(fj==2010) %>%
              group_by(gkz_neu) %>%
              filter(row_number()==1) %>%
              rename(ew2010=ew) %>%
              select(gkz_neu, ew2010))

ansaetze_gemeinden_gruppen <- ansaetze_data_ew2010 %>%
  filter(gruppe %in% ansaetze_gruppen) %>%
  filter(hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(gruppenausgabenprokopf = round(sum(soll)/first(ew),2))

ansaetze_gemeinden_gruppen_ew2010 <- ansaetze_data_ew2010 %>%
  filter(gruppe %in% ansaetze_gruppen) %>%
  filter(hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew2010) %>%
  summarise(gruppenausgabenprokopf = round(sum(soll)/first(ew2010),2))

# bind_rows(ansaetze_gemeinden_gruppen, posten_gemeinden_gruppen) %>%
#   select(-ew) %>%
#   spread(fj, gruppenausgabenprokopf) %>%
#   drop_na() %>%
#   mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
#        avg15_17 = (`2015`+`2016`+`2017`)/3, 
#        avg_diff = (avg15_17/avg12_14-1)*100) %>%
#   mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
#   group_by(gruppe, gsrbetr, avg_diff_posneg) %>%
#   summarise(count=n()) %>%
#   spread(avg_diff_posneg, count) %>%
#   mutate(pct=round(steigen/(sparen+steigen)*100,1))


bind_rows(ansaetze_gemeinden_gruppen_ew2010, posten_gemeinden_gruppen_ew2010) %>%
  select(-ew2010) %>%
  spread(fj, gruppenausgabenprokopf) %>%
  drop_na() %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3,
       avg15_17 = (`2015`+`2016`+`2017`)/3,
       avg_diff = (avg15_17/avg12_14-1)*100) %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gruppe, gsrbetr, avg_diff_posneg) %>%
  summarise(count=n()) %>%
  spread(avg_diff_posneg, count) %>%
  mutate(pct=round(steigen/(sparen+steigen)*100,1)) %>%
  select(-sparen,-steigen) %>%
  spread(gsrbetr, pct)
```
 
## Diagramm: Gestiegene Verwaltungsausgaben in fast allen fusionierten Gemeinden
Vergleich des Drei-Jahres-Durchschnitts für Verwaltungsausgaben pro Kopf vor und nach der Reform.
### Frage:
Wie würde sich dieses Diagramm ändern, wenn man die Einwohnerzahlen auf dem Niveau von 2010 fixiert?
 
 
```{r}
verwaltungsausgabenprokopf_2010_ohnegraz <- verwaltungsausgaben_einwohner2010_progemeinde %>%
  mutate(vwausgabenprokopf=vwausgaben/ew2010) %>%
  filter(gkz_neu!=60101) %>%
  ungroup() %>%
  select(fj, gkz_neu, vwausgabenprokopf, gsrbetr) %>%
  spread(fj, vwausgabenprokopf) %>%
  mutate(avg12_14 = round((((`2012`+`2013`+`2014`)/3)),1),
         avg15_17 = round((((`2015`+`2016`+`2017`)/3)),1), 
         avg_diff = round((((avg15_17/avg12_14-1)*100)),1), 
         avg11_12 = round((((`2012`+`2011`)/2)),1), 
         avg16_17 = round((((`2016`+`2017`)/2)),1), 
         avg_diff_12_17 = round((((avg16_17/avg11_12-1)*100)),1))


#Verwaltungsausgaben pro Kopf zeichnen
map_data_vw <- verwaltungsausgabenprokopf_2010_ohnegraz %>%
  left_join(gde_18_2_splitter, by = c("gkz_neu" = "GKZ")) %>% 
  filter(gsrbetr=="Ja")


plot_vwausgabenohnegrazmap <- ggplot() +
  geom_sf(data = bezirksgrenzen, color="black", size = 0.1) +
  geom_sf(data = map_data_vw, aes(fill=avg_diff), color="black", size=0.01) +
  coord_sf() +
  scale_fill_gradient2(low = "green", midpoint = 0, mid = "white", high = "#ba2b58")+
  labs(x = NULL, y = NULL, title = "Verwaltungskosten pro Kopf (EW 2010): Erhöhung oder Ersparnis?", caption = "Quelle: Statistik Austria, BEV.") +
  theme_map() +
  theme(panel.grid.major = element_line(colour = "white"))

plot(plot_vwausgabenohnegrazmap)
```
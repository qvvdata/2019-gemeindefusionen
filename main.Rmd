---
title: "Analyse der Gemeinstrukturreform und Verwaltungsausgaben in Österreichs Gemeinden seit 2010"
subtitle: "Das wird ein Spaß"
author: "Gerald Gartner, Markus Hametner, Gabriel Hellmann"
date: "11-2018"
output:
  html_document:
    code_folding: show
    toc: yes
    toc_float: 
      collapsed: false
      smooth_scroll: false
---


```{r, echo=FALSE}
# CONFIG
user_name <- "qvvdata" # your Git username (only needed if
# you want to deploy to GH pages)
project_name <- "2019-gemeindefusionen" # adapt!
package_date <- "2018-10-10" # date of the CRAN snapshot that
# the checkpoint package uses
```

## Notes

This report was generated on `r Sys.time()`.

...

### R-Script & data

The preprocessing and analysis of the data was conducted in the [R project for statistical computing](https://www.r-project.org/). The RMarkdown script used to generate this document and all the resulting data can be downloaded [under this link](http://`r user_name`.github.io/`r project_name`/rscript.zip). Through executing `main.Rmd`, the herein described process can be reproduced and this document can be generated. In the course of this, data from the folder `ìnput` will be processed and results will be written to `output`. 
The code for the herein described process can also be freely downloaded from [https://github.com/`r user_name`/`r project_name`](https://github.com/`r user_name`/`r project_name`). 

## Preparations

```{r, echo=FALSE}
detach_all_packages <- function() {
  basic_packages_blank <-  c("stats",
                             "graphics",
                             "grDevices",
                             "utils",
                             "datasets",
                             "methods",
                             "base")
  basic_packages <- paste("package:", basic_packages_blank, sep = "")

  package_list <- search()[
    ifelse(unlist(gregexpr("package:", search())) == 1, TRUE, FALSE)]

  package_list <- setdiff(package_list, basic_packages)

  if (length(package_list) > 0)  for (package in package_list) {
    detach(package, character.only = TRUE, unload = TRUE)
    print(paste("package ", package, " detached", sep = ""))
  }
}

detach_all_packages()

# this allows multiple persons to use the same RMarkdown
# without adjusting the working directory by themselves all the time
source("scripts/csf.R")
path_to_wd <- csf() # if this - for some reason - does not work, 
# replace with a hardcoded path, like so: "~/projects/rddj-template/analysis/"
if ( is.null(path_to_wd) | !dir.exists(path_to_wd)) {
  print("WARNING: No working directory specified for current user")
} else {
  setwd(path_to_wd)
}
```


### Define packages

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# from https://mran.revolutionanalytics.com/web/packages/checkpoint/vignettes/using-checkpoint-with-knitr.html
# if you don't need a package, remove it from here (commenting is probably not sufficient)
# tidyverse: see https://blog.rstudio.org/2016/09/15/tidyverse-1-0-0/
cat("
library(tidyverse) # ggplot2, dplyr, tidyr, readr, purrr, tibble
library(rlang)
library(magrittr) # pipes
library(readxl) # excel
library(jsonlite) # json
library(forcats) # easier factor handling,
library(lintr) # code linting
library(rmapshaper) # simplify 
library(xlsx) #Excel
library(sf) # Maps
library(googlesheets) # googlesheets (replace with googlesheets4 asap)",
file = "manifest.R")
```

### Install packages

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# if checkpoint is not yet installed, install it (for people using this
# system for the first time)
if (!require(checkpoint)) {
  if (!require(devtools)) {
    install.packages("devtools", repos = "http://cran.us.r-project.org")
    require(devtools)
  }
  devtools::install_github("checkpoint",
                           username = "RevolutionAnalytics",
                           ref = "v0.3.2", # could be adapted later,
                           # as of now (beginning of July 2017
                           # this is the current release on CRAN)
                           repos = "http://cran.us.r-project.org")
  require(checkpoint)
}
# nolint start
if (!dir.exists("~/.checkpoint")) {
  dir.create("~/.checkpoint")
}
# nolint end
# install packages for the specified CRAN snapshot date
checkpoint(snapshotDate = package_date,
           project = path_to_wd,
           verbose = T,
           scanForPackages = T,
           use.knitr = F)
rm(package_date)
```


### Load packages

```{r, echo=TRUE, message=FALSE, warning=FALSE}
source("manifest.R")
unlink("manifest.R")
sessionInfo()
```

### Load additional scripts

```{r message=FALSE, warning=TRUE, include=FALSE}
# if you want to outsource logic to other script files, see README for 
# further information
knitr::read_chunk("scripts/theme_addendum.R")
source("./scripts/theme_addendum.R")
source("./scripts/BorderMan.R")
source("./scripts/01-preprocessing.R")
source("./scripts/verwaltungsausgaben.R")
cat(getwd())
options(scipen=999)

```


# Amtsausstattung: Ein neues Gemeindeamt und das verschönert nach dem Zusammenzuzuziehen? 
# Durchschnittliche Steierungsrate der Energie / Personalkosten in allen sieben Bundesländern?
# Gewählte Gemeindeorgane: Aufwandsentschädigung je nach Größe der Gemeinde
# Fuhrpark: eiegener Bagger doer das Teilen von Rasenmähern?

# Steigerung der Aufwendungen pro Kopf und insgesamt?

# Ansätze --> Kostenstellen
# Alle Aufwendungen für Effekte, im Verwaltungsbereich, da sind auch Handelswaren Büroeinrichtung dabei, 

# Posten --> Kostenart, Wofür wurde Geld ausgegeben, bei denen wissen 
# - Ist der Personalaufwand gestiegen oder gefallen, über alle 


```{r, echo=TRUE, message=FALSE, warning=FALSE}
needs(directlabels)
#Wie hat sich die durchschnittliche Gemeindegröße je Bundesland verändert?
gemgr <- gemstruktur %>%
  filter(gemeindegrößenklasse=="Insgesamt" & bl!="wien")%>%
  spread(typ, value)%>%
  mutate(avggem = bev/gemzahl)

needs(directlabels)
plot_gemgr <- ggplot(gemgr, aes(jahr, avggem, color = bl)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = bl), method="angled.boxes")

plot_gemgr

#Wie hat sich die Gemeindezahl je Bundesland verändert?
gemzahl <- gemstruktur %>%
  filter(gemeindegrößenklasse=="Insgesamt" & bl!="wien" & bl!="österreich")%>%
  spread(typ, value)%>%
  mutate(avggem = bev/gemzahl)

plot_gemzahl <- ggplot(gemzahl, aes(jahr, gemzahl, color = bl)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = bl), method="angled.boxes")+
  expand_limits(y = 0)

# Veränderung durchschnittlicher Zahl
gemstrukturdiff <- gemgr %>%
  #filter(jahr=="1961" | jahr =="2018") %>%
  select(bl, jahr, avggem)%>%
  spread(jahr, avggem)%>%
  mutate(diff6118 = (`2018`/`1961`-1)*100, 
         diff6181 = (`1981`/`1961`-1)*100, 
         diff1118 = (`2018`/`2011`-1)*100)

```

#Erkenntnisse durchschnittliche Gemeindegröße
Die Gemeindestrukturreform in den 70er-Jahren hat in Niederösterreich zur Verdreifachung der durchschnittlichen Gemeindegröße geführt. In der Steiermark selbst hat sich diese Zahl verdoppelt. Allerdings war  das Niveau ein anderes. Mit einer durchschnittlichen Einwohnerzahl von 850 war Niederösterreich 1961 sehr kleinstrukturiert. In der Steiermark war die durchschnittliche Größe 2011 vor der Reformpartnerschaft mit 2230 Bürgern pro Gemeinde zwar vorletzter im Österreich-Vergleich, aber schon drei Mal so groß wie in Niederösterreich. 

Wie haben sich die Personalausgaben pro Kopf je Gemeinde verändert? Welche Unterschiede gibt es nach Gemeindegrößentyp?

```{r}

personalkostenprokopf <- posten_data %>%
  filter(gruppe=="Personal") %>%
  filter (hh=="1") %>%
  # filter(post3!='729', ans2!='90')  %>% # Hat der Posten 729/ Ansatz 90 Auswirkungen auf Zählung? --> Nein
  filter(gkz_neu >60000 & gkz_neu <70000) %>% 
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(personalausgaben = sum(soll)) %>%
  mutate(personalausgabenprokopf = round(personalausgaben/ew,2)) %>%
    ungroup() %>%
  select(fj, gkz_neu, name,personalausgabenprokopf, gsrbetr) %>%
  spread(fj, personalausgabenprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)

# Wie verläuft der Kostentrend zwischen 2015 und 2017? Ist ein Abwärtstrend erkennbar?
needs(forecast)
personalkostenprokopf$trend <- NA
personalkostenprokopf$pvalue <- NA
for (i in 1:nrow(personalkostenprokopf)){
  
  werte <- as.ts(as.vector(t(personalkostenprokopf[i,][9:11])))
  fit <- tslm(werte~trend)
  trend <- fit$coefficients[2]
  pvalue <- summary(fit)$coefficients[2,4]
  
  personalkostenprokopf$trend[i] <- trend
  personalkostenprokopf$pvalue[i] <- pvalue
  
  cat(trend)
  cat(pvalue)
  
  
}

personalkostenprokopf$sig <- NA  
personalkostenprokopf$sig[personalkostenprokopf$pvalue<=0.10] <- "Signifikant 5%"
personalkostenprokopf$sig[personalkostenprokopf$pvalue> 0.10] <- "Insignifikant 5%"
personalkostenprokopf$posneg[personalkostenprokopf$trend >= 0] <- "positiv"
personalkostenprokopf$posneg[personalkostenprokopf$trend <= 0] <- "negativ"
  
personalkostenprokopf_fus <- personalkostenprokopf %>%
  filter(gsrbetr=="Ja")

klz_personalkostenprokopf_fus <-  personalkostenprokopf_fus %>%
  arrange(-avg_diff) %>%
  top_n(20, avg_diff)

personalkostenprokopf_nfus <- personalkostenprokopf %>%
  filter(gsrbetr=="Nein")

personalkostenprokopf_summary <- personalkostenprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
  spread(avg_diff_posneg, count) %>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))

personalkostenprokopf_map <- bind_rows(personalkostenprokopf_fus, personalkostenprokopf_nfus) %>% select(-c(trend, pvalue, sig, posneg))
  
write.xlsx(personalkostenprokopf_map, "output/ignore/klz_personalkostenprokopf.xlsx", sheetName = "Personalkosten pro Kopf")


#Personalkosten pro Kopf zeichnen zeichnen
map_data <- personalkostenprokopf_map %>% mutate(gkz_neu=as.character(gkz_neu)) %>% left_join(gde_18, by = c("gkz_neu" = "GKZ")) %>% 
  filter(gsrbetr=="Ja")

map_data <- gde_18 %>% 
  mutate(gkz_neu=as.numeric(GKZ)) %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  left_join(personalkostenprokopf_map, by = c("gkz_neu" = "gkz_neu"))

bezirksgrenzen <- bezirksgrenzen %>%
  mutate(BEZ = as.numeric(BEZ)) %>%
    filter(BEZ > 600 & BEZ <700) %>%
  mutate(BEZ = as.character(BEZ))


needs(ggthemes)
plot_1 <- ggplot() +
  # municipality polygons & outline
  geom_sf(data = bezirksgrenzen, color="white", size = 1) +
  geom_sf(data = map_data, aes(fill=avg15_17), color="white", size=0.001) +
  #geom_sf(data = bundeslaendergrenzen, color="white", fill="transparent", size=0.1) +
  coord_sf() +
  #coord_map(projection = "mercator") +
  # coord_sf did not work here
  scale_fill_gradient(low = "#E1A9A9", high = "#571F1E", 
                       space = "Lab", na.value = "yellow", guide = "colourbar") +
  labs(x = NULL, y = NULL, title = "Höhe der Personalkosten pro Kopf", caption = "Quelle: Statistik Austria, BEV.") +
  #guides(fill=guide_legend(nrow=6,byrow=TRUE))+
  theme_map()+
  theme(panel.grid.major = element_line(colour = "white"))
print(plot_1)

add_save(add_theme(plot_1 + labs(title=NULL, caption=NULL)),'personalkostenprokopf')


# Ansätze nicht zusammenwerfen, also wo sind die Personalkosten warum gestiegen 
personalkostenprokopf_mitansaetzen <- posten_data %>%
  filter(gruppe=="Personal") %>%
  filter (hh=="1") %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew, ans2, ansatz_bez) %>%
  summarise(personalausgaben = sum(soll)) %>%
    ungroup() %>%
  mutate(personalausgabenprokopf = round(personalausgaben/ew,2)) %>%
  select(fj, gkz_neu, name, personalausgabenprokopf, gsrbetr, ans2, ansatz_bez) %>%
  spread(fj, personalausgabenprokopf) %>%
  ungroup() %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)



```

In sieben von 119 von der Gemeindestrukturreform betroffenen Gemeinden sind die Personalkosten pro Kopf gesunken. In der anderen 96 Prozent der Gemeinden sind die Personalkosten pro Kopf gestiegen. Bei jenen Gemeinden, die von der Gemeindestrukturreform nicht betroffen waren, sind die Personalkosten pro Kopf in 23 von 158 gesunken. In den verbleibenden 85 Prozent sind die Kosten gestiegen. 

8/127 (96 %) gestiegene Kosten pro Kopf für Personal in fusionierten Gemeinden
23/158 (85 %) gestiegene Kosten pro Kopf für Personal in nicht fusionierten Gemeinden

#Wie haben sich die Personalausgaben absolut je Gemeinde verändert? Welche Unterschiede gibt es nach Gemeindegrößentyp?
```{r}
personalausgaben_absolut <- posten_data %>%
  filter(gruppe=="Personal") %>% # auf welchen Ansatz/Haushalt muss hier gefiltert werden? --> Gabriel fragen! Aktuell keine Filterung
  filter (hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gsrbetr) %>%
  summarise(personalausgaben = sum(soll)) %>%
  #mutate(personalausgabenprokopf = round(personalausgaben/ew,2)) %>%
  select(fj, personalausgaben, gsrbetr) %>%
  ungroup()
  #spread(fj, personalausgaben) %>%
  #mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
    #     avg15_17 = (`2015`+`2016`+`2017`)/3, 
    #     avg_diff = (avg15_17/avg12_14-1)*100)

# Filter auf steirische Gemeinden, die von GSR betroffen waren 
personalausgaben_absolut_fus <- personalausgaben_absolut %>%
  filter(gsrbetr=="Ja")

# Filter auf steirische Gemeinden, die von GSR nicht betroffen waren 
personalausgaben_absolut_nfus <- personalausgaben_absolut %>%
  filter(gsrbetr=="Nein")
```

In neun von 127 von der Gemeindestrukturreform betroffenen Gemeinden sind die Personalkosten absolut gesunken. In der anderen 93 Prozent der Gemeinden sind die Personalkosten absolut tendenziell gestiegen. Bei jenen Gemeinden, die von der Gemeindestrukturreform nicht betroffen waren, sind die Personalkosten absolut in 22 von 158 gesunken. In den verbleibenden 86 Prozent sind die Kosten gestiegen.



```{r}
# Map der Personalkostensteigerung pro Kopf
# map dat mit Daten für die Visualisierung mergen
map_data <- personalkostenprokopf_map %>% mutate(gkz_neu=as.character(gkz_neu)) %>% left_join(gde_18, by = c("gkz_neu" = "GKZ")) %>%
  filter(gsrbetr=="Ja")

#Personalkosten pro Kopf Erhöhung zeichnen zeichnen
plot_1 <- ggplot() +
  # municipality polygons & outline
  geom_sf(data = map_data, aes(fill=avg_diff), color="white", size=0.001) +
  #geom_sf(data = bundeslaendergrenzen, color="white", fill="transparent", size=0.1) +
  coord_sf() +
  #coord_map(projection = "mercator") +
  # coord_sf did not work here
  scale_fill_gradient2(low = "#84a07c", midpoint = 0, mid = "grey", high = "#ba2b58")+
  #scale_fill_gradient(low = "#bf4342", high = "#519872", 
  #                     space = "Lab", na.value = "#af3b6e", guide = "colourbar") +
  labs(x = NULL, y = NULL, title = "personalkostenprokopferhöhung", caption = "Quelle: Statistik Austria, BEV.") +
  guides(fill=guide_legend(nrow=6,byrow=TRUE)) +
  theme_map() +
  theme(panel.grid.major = element_line(colour = "white"))

plot(plot_1)
#add_save(add_theme(plot_1 + labs(title=NULL, caption=NULL)),'rueckkehrer')


```

# Alles zusammen heißt gemeindereferate: 
# Amt- für Raumordnung Raum-Management
# Bauamt
# Sozialamt
# STandesamt
# Zentralamt

# Amtsgebäude
# Freiwillige Feuerwehren
# Fuhrpark
# Wirtschaftshöfe
# Gewählte GEmeindeorgane



```{r}
#Energiekosten pro Kopf
energiekostenprokopf <- posten_data %>%
  filter(gruppe=="Energie") %>% # auf welchen Ansatz/Haushalt muss hier gefiltert werden? --> Gabriel fragen! Aktuell keine Filterung
  filter (hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(energieausgaben = sum(soll))%>%
  mutate(energieausgabenprokopf = round(energieausgaben/ew,2)) %>%
  select(fj, gkz_neu, name, energieausgabenprokopf, gsrbetr) %>%
  ungroup() %>%
  spread(fj, energieausgabenprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)
  
energiekostenprokopf_fus <- energiekostenprokopf %>%
  filter(gsrbetr=="Ja")

energiekostenprokopf_nfus <- energiekostenprokopf %>%
  filter(gsrbetr=="Nein")
  
print(energiekostenprokopf_summary <- energiekostenprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
    spread(avg_diff_posneg, count))%>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))




```


#Berechnungen nach den Ansätzen/Kostenstellen ohne Posten für Gemeindereferate ("Standesamt", "Bauamt", "Amt für Raumordnung und Raumplanung", "Sozialamt", "Zentralamt")
```{r}
referateprokopf <- ansaetze_data %>%
  filter(gruppe=="gemeindereferate") %>% 
  filter (hh=="1") %>%
   filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(referateausgaben = sum(soll)) %>%
  mutate(referateausgabenprokopf = round(referateausgaben/ew,2)) %>%
  select(fj, gkz_neu, name, referateausgabenprokopf, gsrbetr) %>%
  ungroup() %>%
  spread(fj, referateausgabenprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)
  
referateprokopf_fus <- referateprokopf %>%
  filter(gsrbetr=="Ja")


referateprokopf_nfus <- personalkostenprokopf %>%
  filter(gsrbetr=="Nein")  

print(referateprokopf_summary <- referateprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
    spread(avg_diff_posneg, count))%>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))

```
89/127 gestiegene Kosten für Referate pro Kopf (67 %) bei fusionierten
126/158 gestiegene Kosten für Referate pro Kopf (85 %) bei nicht fusionierten

#Berechnungen nach den Ansätzen/Kostenstellen ohne Posten für Feuerwehren

```{r}
feuerwehrenprokopf <- ansaetze_data %>%
  filter(gruppe=="Freiwillige Feuerwehren") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  filter (hh=="1") %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(feuerwehren = sum(soll)) %>%
  mutate(feuerwehrenprokopf = round(feuerwehren/ew,2)) %>%
  select(fj, gkz_neu, name, feuerwehrenprokopf, gsrbetr) %>%
  ungroup() %>%
  spread(fj, feuerwehrenprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)
  
feuerwehrenprokopf_fus <- feuerwehrenprokopf %>%
  filter(gsrbetr=="Ja")


feuerwehrenprokopf_nfus <- feuerwehrenprokopf %>%
  filter(gsrbetr=="Nein")  

print(feuerwehrenprokopf_summary <- feuerwehrenprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
    spread(avg_diff_posneg, count))%>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))
```

69/127 (50 %) gestiegene Kosten pro Kopf für Feuerwehren in fusionierten Gemeinden
90/158 (51 %) gestiegene Kosten pro Kopf für Feuerwehren in nicht fusionierten Gemeinden


#Berechnungen nach den Ansätzen/Kostenstellen ohne Posten für gewählte Gemeindeorgane
```{r}
gemeindeorganeprokopf <- ansaetze_data %>%
  filter(gruppe=="Gewaehlte Gemeindeorgane") %>%
  filter (hh=="1") %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(gemeindeorgane = sum(soll)) %>%
  mutate(gemeindeorganeprokopf = round(gemeindeorgane/ew,2)) %>%
  select(fj, gkz_neu, name, gemeindeorganeprokopf, gsrbetr) %>%
  ungroup() %>%
  spread(fj, gemeindeorganeprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)
  
gemeindeorganeprokopf_fus <- gemeindeorganeprokopf %>%
  filter(gsrbetr=="Ja")


gemeindeorganeprokopf_nfus <- gemeindeorganeprokopf %>%
  filter(gsrbetr=="Nein") 

print(gemeindeorganeprokopf_summary <- gemeindeorganeprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
    spread(avg_diff_posneg, count))%>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))

# Testen warum Beträge höher als in Gabriels Dokument
gemeindeorgane_check <- ansaetze_data %>%
  filter(gruppe=="Gewaehlte Gemeindeorgane") %>%
  filter (hh=="1")


# Kalkulieren der Bevölkerung für die Ja-Nein-Gsrbetr Gemeinden total 
gsrbetr_bev_gemorg <- gemeinden_reg %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
  select(gkz_neu,jahr,ew) %>%
 # group_by(gkz_neu, jahr) %>%
  left_join(gsr15, by=c("gkz_neu"="gkz"))

gsrbetr_bev_t_gemorg <- gsrbetr_bev_gemorg %>%
  group_by(gsrbetr, jahr) %>%
  summarise(ew = sum(ew)) 

# Join der Bevölkerung mit den GR-Ausgaben
gemeindeorganeprokopf_line <- ansaetze_data %>%
  filter(gkz_neu %not in% teilungen_exkl) %>%
  filter(gruppe=="Gewaehlte Gemeindeorgane") %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
  filter (hh=="1") %>%
  group_by(fj, gsrbetr) %>%
  summarise(gemeindeorgane = sum(soll))

gemeindeorganeprokopf_line_gsrbetr_t <- gemeindeorganeprokopf_line %>%
  left_join(gsrbetr_bev_t_gemorg, by=c("gsrbetr"="gsrbetr", "fj"="jahr")) %>%
  mutate(gemeindeorganeprokopf = round((gemeindeorgane/ew),2)) 


plot21 <- ggplot(gemeindeorganeprokopf_line_gsrbetr_t, aes(fj, gemeindeorganeprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = gsrbetr), method="angled.boxes")+
  ylim(0, 70)+
   theme_minimal()
plot(plot21) 
 
ggsave("output/ignore/plot21.pdf", device="pdf")

gemeindeorganeprokopf_line_gsrbetr_t_exp <- gemeindeorganeprokopf_line_gsrbetr_t %>%
  select(-c(ew, gemeindeorgane)) %>%
  spread(fj, gemeindeorganeprokopf)



# Gemeindeorgane insgesamt 
gemeindeorgane_absolut_gsrbetr <- ansaetze_data %>%
  filter(gruppe=="Gewaehlte Gemeindeorgane") %>%
  filter (hh=="1") %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
  group_by(fj, gsrbetr, gruppe) %>%
  summarise(gemeindeorgane = sum(soll))

gemeindeorgane_absolut_gsrbetr_plot <- ggplot(gemeindeorgane_absolut_gsrbetr, aes(fj, gemeindeorgane, color = gsrbetr)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = gsrbetr), method="angled.boxes")+
  ylim(0, 37000000)+
   theme_minimal()
plot(gemeindeorgane_absolut_gsrbetr_plot)  


ggsave("output/ignore/gemeindeorgane_absolut_gsrbetr_plot.pdf", device="pdf")

# Table für Gemeideorganeausgaben
gemeindeorgane_absolut_gsrbetr_table <- gemeindeorgane_absolut_gsrbetr %>%
  spread(fj, gemeindeorgane) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`), 
         avg15_17 = (`2015`+`2016`+`2017`), 
         avg_diff = (avg15_17/avg12_14-1)*100) %>%
  rename(`Summe 12-14`= avg12_14, 
         `Summe 15-17`= avg15_17, 
         `Differenz vorher/nachher in %` = avg_diff) %>%
  select(-gruppe)
options(knitr.table.format = "html")
library(knitr)
library(kableExtra)
gemeindeorgane_absolut_gsrbetr_table %>% 
  kable(caption = "Ausgaben für gewählte Gemeindeorgane absolut in Euro") %>%
  kable_styling()

```
21/127 (17 %) gestiegene Kosten pro Kopf für gewählte Gemeindeorgane in fusionierten Gemeinden
158/158 (100%) gestiegene Kosten pro Kopf für gewählte Gemeindeorgane in nicht fusionierten Gemeinden

#Berechnungen nach den Ansätzen/Kostenstellen ohne Posten für Amtsgebäude
```{r}
amtsgebaeudeprokopf <- ansaetze_data %>%
  filter(gruppe=="Amtsgebaeude") %>% 
  filter (hh=="1") %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(amtsgebaeude = sum(soll)) %>%
  mutate(amtsgebaeudeprokopf = round(amtsgebaeude/ew,2)) %>%
  select(fj, gkz_neu, name, amtsgebaeudeprokopf, gsrbetr) %>%
  ungroup() %>%
  spread(fj, amtsgebaeudeprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)
  
amtsgebaeudeprokopf_fus <- amtsgebaeudeprokopf %>%
  filter(gsrbetr=="Ja")


amtsgebaeudeprokopf_nfus <- amtsgebaeudeprokopf %>%
  filter(gsrbetr=="Nein")  


```
Keine umfassende Betrachtung möglich, weil Daten fehlen von vielen Gemeinden. 


#Berechnungen nach den Ansätzen/Kostenstellen ohne Posten für Wirtschaftshoefe (Bauhof)

```{r}
bauhofprokopf <- ansaetze_data %>%
  filter(gruppe=="Wirtschaftshoefe (Bauhof)") %>% 
  filter (hh=="1") %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(bauhof = sum(soll)) %>%
  mutate(bauhofprokopf = round(bauhof/ew,2)) %>%
  select(fj, gkz_neu, name, bauhofprokopf, gsrbetr) %>%
  ungroup() %>%
  spread(fj, bauhofprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)
  
bauhofprokopf_fus <- bauhofprokopf %>%
  filter(gsrbetr=="Ja")


bauhofprokopf_nfus <- bauhofprokopf %>%
  filter(gsrbetr=="Nein")  

print(bauhofprokopf_summary <- bauhofprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
    spread(avg_diff_posneg, count))%>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))

```

54/101 gestiegene Kosten pro Kopf bei Bauhöfen in fusionierten Gemeinden
35/57 gestiegene Kosten pro Kopf bei Bauhöfen in nicht fusionierten Gemeinden

#Berechnungen nach den Ansätzen/Kostenstellen ohne Posten für Fuhrpark

```{r}
fuhrparkprokopf <- ansaetze_data %>%
  filter(gruppe=="Fuhrpark") %>% 
  filter (hh=="1") %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(fuhrpark = sum(soll)) %>%
  mutate(fuhrparkprokopf = round(fuhrpark/ew,2)) %>%
  select(fj, gkz_neu, name, fuhrparkprokopf, gsrbetr) %>%
  ungroup() %>%
  spread(fj, fuhrparkprokopf) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)
  
fuhrparkprokopf_fus <- fuhrparkprokopf %>%
  filter(gsrbetr=="Ja")

fuhrparkprokopf_nfus <- fuhrparkprokopf %>%
  filter(gsrbetr=="Nein")  

print(fuhrparkprokopf_summary <- fuhrparkprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
    spread(avg_diff_posneg, count))%>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))
```
44/70  (63 %) gestiegene Kosten pro Kopf bei Fuhrpark in fusionierten Gemeinden
34/65  (52 %) gestiegene Kosten pro Kopf bei Fuhrpark in nicht fusionierten Gemeinden

```{r}
# Wie hoch sind die Förderungen je Gemeinde für politische Parteien?
foerderungen_parteien_gem <- posten_data %>%
  filter(ans2=="00" & post3=="757" & fj =="2017") %>%
  filter (hh=="1") 

test <- foerderungen_parteien_gem %>%
  group_by(gkz_neu) %>%
  summarise(n_distinct(gkz_neu))

foerderungen_parteien_gem_bl <- posten_data %>%
  filter(ans2=="00" & post3=="757")  %>%
  filter (hh=="1") %>%
  mutate(blcode = substr(gkz_neu, 1,1)) %>%
  group_by(fj, ans2, post3, blcode) %>%
  summarise(sum = sum(soll))

options(scipen=999)

# Welche GEmeinden geben pro Kopf 2017 am meisten für ihre Parteien aus?
foerderungen_parteien_gem_avg <- posten_data %>%
  filter(ans2=="00" & post3=="757" & fj =="2017")  %>%
  filter (hh=="1") %>%
  mutate(sollproew = round(soll/ew, 1))%>%
  arrange(-sollproew)%>%
  ungroup() %>%
  select(gkz_neu, name, soll, ew, sollproew) %>%
  arrange(-sollproew) %>%
  top_n(20, sollproew)

write.xlsx(foerderungen_parteien_gem_avg, "output/ignore/foerderungen_parteien_gem_avg.xlsx")

# Waren die Top-20-Gemeinden auch in den Vorjahren führend/überdurchschnittlich?
foerderungen_parteien_gem_avg_allyears <- posten_data %>%
  filter(ans2=="00" & post3=="757" & gkz_neu %in% foerderungen_parteien_gem_avg$gkz_neu)  %>%
  filter (hh=="1") %>%
  mutate(sollproew = round(soll/ew, 1)) %>%
  ungroup() %>%
  select(gkz_neu, name, fj, sollproew) 

foerderungen_parteien_gem_avg_allyears_spreaded <- foerderungen_parteien_gem_avg_allyears%>%
  spread(fj, sollproew)

foerderungen_parteien_gem_avg_allyears_top <- ggplot(foerderungen_parteien_gem_avg_allyears, aes(fj, sollproew, color = name)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = name), method="angled.boxes")

foerderungen_parteien_gem_avg_allyears_top

# Gemeindeförderungen je Partei Export Datawrapper
foerderungen_parteien_gem_avg_allyears_dw <- posten_data %>%
  filter(ans2=="00" & post3=="757" & fj=="2017") %>%
  filter (hh=="1") %>%
  mutate(sollproew = round(soll/ew, 1)) %>%
  ungroup()
  
#Wie hoch ist der durchschnitt in allen Gemeinden 2017?
foerderungen_parteien_gem_avg_allyears_dw_all <- posten_data %>%
  filter(ans2=="00" & post3=="757") %>%
  filter (hh=="1") %>%
  group_by(ans2, fj) %>%
  summarise(sumew = sum(ew), 
            sumsoll = sum(soll)) %>%
  mutate(sollproew = round(sumsoll/sumew, 2), 
         name = "Österreich") 

gkz_tv <- c("31042", "31513")

# Hürm und Seefeeld Kadolz
foerderungen_parteien_gem_avg_allyears_dw_tv <- posten_data %>%
  filter(ans2=="00" & post3=="757" & gkz_neu %in% gkz_tv) %>%
  filter (hh=="1") %>%
  group_by(ans2, fj, name) %>%
  summarise(sumew = sum(ew), 
            sumsoll = sum(soll)) %>%
  mutate(sollproew = round(sumsoll/sumew, 2))

# 
foerderungen_parteien_gem_avg_allyears_dw_combined <- bind_rows(foerderungen_parteien_gem_avg_allyears_dw_tv, foerderungen_parteien_gem_avg_allyears_dw_all) %>%
  gather( typ, wert,sumew:sollproew) %>%
  filter(typ=="sollproew") %>%
  spread(fj, wert)%>% 
  ungroup() %>%
  select(-c(typ, ans2))

foerderungen_parteien_gem_avg_allyears_dw_combined <- as.data.frame(foerderungen_parteien_gem_avg_allyears_dw_combined) 
    
needs(xlsx)

write.xlsx(foerderungen_parteien_gem_avg_allyears_dw_combined, "output/ignore/foerderungen_parteien_gem_avg_allyears_dw_combined.xlsx", row.names=FALSE)


# Export für die Karte oder die Tabelle
foerderungen_parteien_map <- foerderungen_parteien_gem %>%
  mutate(sollprokopf = round((soll/ew), 2), 
         soll = round(soll,0)) %>%
  select(gkz_neu, name, soll, sollprokopf) 

gemeinden_reg18 <- gemeinden_reg %>% 
  left_join(foerderungen_parteien_map, by=c("gkz_neu"="gkz_neu"))%>% 
  filter(jahr==2017) %>%
  rename(jahr2 = jahr, 
         gkz= gkz_neu)


# gemeinden_reg18_t <- borderman_propagate_fusions(gemeinden_reg18) %>%
#   ungroup() %>%
#   select(gkz, `name.x`, soll, sollprokopf) %>%
#   mutate(soll = replace_na(soll, 0), 
#          sollprokopf = replace_na(sollprokopf, 0))%>%
#   rename(name = `name.x`)
# 
# write.xlsx(gemeinden_reg18_t, "output/ignore/gemeinden_reg18_t.xlsx")





```

# Tooltip
In <name> gingen <soll> Euro aus der Gemeindekasse an Parteien. Das sind X.Y Euro pro Gemeindebürger. Das ist <durchschnittlich/unter/über> viel.

# Herausrechnen von Außerordentlichen Einnahmen und Ausgaben. Je Tabellenblatt ein Ansatz. Wenn es da Auffälligkeiten gibt, sollten wir bei einer qualitativen Analyse sehen, wo ein Amtsgebäude verkauft wurde, ein neues Feuerwehrauto gekauft wurde etc. 

# 5 ao Ausgaben, 6 ao. Einnahmen, 1 ordentliche ausgaben, 2 ordentliche Einnahmen
```{r}
# Außerordentliche Ausgaben
aoa_stmk_ansaetze <- ansaetze_data %>%
  filter(gkz_neu >60000 & gkz_neu < 70000 & hh=="5") %>%
  group_by(fj, hh, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(soll = sum(soll)) %>%
  select(fj, hh, gkz_neu, name, soll, gruppe, gsrbetr) %>%
  ungroup() %>%
  spread(fj, soll) 

aoa_stmk_ansaetze %>% filter(gruppe=="Gewaehlte Gemeindeorgane") %>% write.xlsx("output/ignore/aoa.xlsx", sheetName = "Gemeindeorgane")
aoa_stmk_ansaetze %>% filter(gruppe=="gemeindereferate") %>% write.xlsx("output/ignore/aoa.xlsx", sheetName = "gemeindereferate", append = TRUE)
aoa_stmk_ansaetze %>% filter(gruppe=="Amtsgebaeude") %>% write.xlsx("output/ignore/aoa.xlsx", sheetName = "Amtsgebaeude", append = TRUE)
aoa_stmk_ansaetze %>% filter(gruppe=="Freiwillige Feuerwehren") %>% write.xlsx("output/ignore/aoa.xlsx", sheetName = "Freiwillige Feuerwehren", append = TRUE)
aoa_stmk_ansaetze %>% filter(gruppe=="Wirtschaftshoefe (Bauhof)") %>% write.xlsx("output/ignore/aoa.xlsx", sheetName = "Wirtschaftshoefe (Bauhof)", append = TRUE)
aoa_stmk_ansaetze %>% filter(gruppe=="Fuhrpark") %>% write.xlsx("output/ignore/aoa.xlsx", sheetName = "Fuhrpark", append = TRUE)

# Außerordentliche Einnahmen
aoe_stmk_ansaetze <- ansaetze_data %>%
  filter(gkz_neu >60000 & gkz_neu < 70000 & hh=="6") %>%
  group_by(fj, hh, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(soll = sum(soll)) %>%
  select(fj, gkz_neu, hh, name, soll, gruppe, gsrbetr) %>%
  ungroup() %>%
  spread(fj, soll) 

aoe_stmk_ansaetze %>% filter(gruppe=="Gewaehlte Gemeindeorgane") %>% write.xlsx("output/ignore/aoe.xlsx", sheetName = "Gemeindeorgane")
aoe_stmk_ansaetze %>% filter(gruppe=="gemeindereferate") %>% write.xlsx("output/ignore/aoe.xlsx", sheetName = "gemeindereferate", append = TRUE)
aoe_stmk_ansaetze %>% filter(gruppe=="Amtsgebaeude") %>% write.xlsx("output/ignore/aoe.xlsx", sheetName = "Amtsgebaeude", append = TRUE)
aoe_stmk_ansaetze %>% filter(gruppe=="Freiwillige Feuerwehren") %>% write.xlsx("output/ignore/aoe.xlsx", sheetName = "Freiwillige Feuerwehren", append = TRUE)
aoe_stmk_ansaetze %>% filter(gruppe=="Wirtschaftshoefe (Bauhof)") %>% write.xlsx("output/ignore/aoe.xlsx", sheetName = "Wirtschaftshoefe (Bauhof)", append = TRUE)
aoe_stmk_ansaetze %>% filter(gruppe=="Fuhrpark") %>% write.xlsx("output/ignore/aoe.xlsx", sheetName = "Fuhrpark", append = TRUE)

# Mieteinnahmen in der Steiermark ordentlich für Gabriel
mieteinnahmen_stmk_ansaetze <- ansaetze_data %>%
  filter(gkz_neu >60000 & gkz_neu < 70000 & hh=="2" & ans3=="029") %>%
  group_by(fj, hh, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(soll = sum(soll)) %>%
  select(fj, gkz_neu, hh, name, soll, gruppe, gsrbetr) %>%
  ungroup() %>%
  spread(fj, soll) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)

mieteinnahmen_stmk_ansaetze %>% write.xlsx("output/ignore/mieteinnahmen_stmk.xlsx", sheetName = "Mieteinnahmen")

# Kannst du eine Auswertung für den Ansatz 029 Amtsgebäude machen (Haushalt 2 – ordentliche Einnahmen). Würde mich interessieren, ob sich da bei den Fusionsgemeinden durch die Fusion etwas getan hat und ob sie auffällig im Vergleich zu den Nichtfusionsgemeinden sind.
# Sprich Veränderung absolut im Schnitt im pro Kopf im Schnitt.
# Könnten wir auch als Thema zum KDZ mitnehmen, weil wenn keine Gemeinde Teile der fusionsbedingt nicht mehr benötigten Amtsgebäude vermietet, wäre das eine Notiz wert.
  
```

```{r}
# Gibt es Cluster in denen viele kleine Gemeinden aneinandergrenzen?
# Voraus als Vorzeigegemeinde
# Pöllau als Blockadebeispiel

# Hartberg mit seinen Umgebungsgemeinden (ergäbe mehr als 10.000 Einwohner) oder von Friedberg und Pinggau nicht angegangen
# Gleisdorf gab es einst Außenstellen, die wurden bald geschlossen

#Verwaltung testen
verwaltungsausgaben <- posten_data %>%
  mutate(post1 = substr(post3,1,1), 
         ans1 = substr(ans2, 1,1)) %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
   filter (hh=="1")  %>% # | hh=="5") %>% # Nur Ausgaben
 filtervw() # lookup verwaltungsausgaben.R for defintion

# Superwichtige Berechnung
verwaltungsausgabenprokopf <- verwaltungsausgaben %>%
  group_by(fj, gkz_neu, name, gsrbetr, ew) %>%
  summarise(vwausgaben = sum(soll)) %>%
  mutate(vwausgabenprokopf = round(vwausgaben/ew,2)) %>%
  ungroup() %>%
  select(fj, gkz_neu, name, vwausgabenprokopf, gsrbetr) %>%
  spread(fj, vwausgabenprokopf) %>%
  mutate(avg12_14 = round((((`2012`+`2013`+`2014`)/3)),1),
         avg15_17 = round((((`2015`+`2016`+`2017`)/3)),1), 
         avg_diff = round((((avg15_17/avg12_14-1)*100)),1), 
         avg11_12 = round((((`2012`+`2011`)/2)),1), 
         avg16_17 = round((((`2016`+`2017`)/2)),1), 
         avg_diff_12_17 = round((((avg16_17/avg11_12-1)*100)),1))

verwaltungsausgabenprokopf_summary <- verwaltungsausgabenprokopf %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
  spread(avg_diff_posneg, count) %>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))

# Herausschreiben für die interaktive Karte

#write_sf(gde_18_2_splitter, "interaktiv/karte/dist/gemeindegrenzen_2018_splitter.geojson", quiet = TRUE)
write_csv(verwaltungsausgabenprokopf %>% select(-`2010`,-`2011`)
          , path = "interaktiv/karte/dist/verwaltungsausgabenprokopf.csv")


vwkostenprokopf_fus <- verwaltungsausgabenprokopf %>%
  filter(gsrbetr=="Ja")

vwkostenprokopf_nfus <- verwaltungsausgabenprokopf %>%
  filter(gsrbetr=="Nein")

#Verwaltungsausgaben pro Kopf zeichnen
map_data_vw <- verwaltungsausgabenprokopf %>% left_join(gde_18_2_splitter, by = c("gkz_neu" = "GKZ")) %>% 
  filter(gsrbetr=="Ja")

map_data <- gde_18 %>% 
  mutate(gkz_neu=as.numeric(GKZ)) %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  left_join(personalkostenprokopf_map, by = c("gkz_neu" = "gkz_neu"))

#


#vew pro Kopf Erhöhung zeichnen zeichnen
plot_10 <- ggplot() +
  # municipality polygons & outline
  geom_sf(data = bezirksgrenzen, color="black", size = 0.1) +
  geom_sf(data = map_data_vw, aes(fill=avg_diff), color="black", size=0.01) +
  #geom_sf(data = bundeslaendergrenzen, color="white", fill="transparent", size=0.1) +
  coord_sf() +
  #coord_map(projection = "mercator") +
  # coord_sf did not work here
  scale_fill_gradient2(low = "#84a07c", midpoint = 0, mid = "white", high = "#ba2b58")+
  #scale_fill_gradient(low = "#bf4342", high = "#519872", 
  #                     space = "Lab", na.value = "#af3b6e", guide = "colourbar") +
  labs(x = NULL, y = NULL, title = "Verwaltungskosten pro Kopf: Erhöhung oder Ersparnis?", caption = "Quelle: Statistik Austria, BEV.") +
 #guides(fill=guide_legend(nrow=6,byrow=TRUE)) +
  theme_map() +
  theme(panel.grid.major = element_line(colour = "white"))

plot(plot_10)
```

```{r}
# Map zeichnen für Animation- Klarer Cut-off Ersparnis/Erhöhung für fusionierte
#Verwaltungsausgaben pro Kopf zeichnen
map_data_vw_anim <- verwaltungsausgabenprokopf %>% left_join(gde_18_2_splitter, by = c("gkz_neu" = "GKZ")) %>% 
  filter(gsrbetr=="Ja") %>%
  mutate(effekt= ifelse(avg_diff<=0, "l", "h"))


#verwaltungsausgabenprokopf pro Kopf Erhöhung/ersparnis  zeichnen
plot_12 <- ggplot() +
  # municipality polygons & outline
  geom_sf(data = bezirksgrenzen, color="darkgrey", size = 0.1) +
  geom_sf(data = map_data_vw_anim, aes(fill=effekt), color="black", size=0.01) +
  coord_sf() +
  scale_fill_manual(values=c("#a54657", "#3d8052"))+
 # labs(x = NULL, y = NULL, title = "Verwaltungskosten pro Kopf: Erhöhung oder Ersparnis?", caption = "Quelle: Statistik Austria, BEV.") +
  theme_map() +
  theme(panel.grid.major = element_line(colour = "white"))

plot(plot_12)
ggsave("output/ignore/plot_12.pdf", device="pdf")

```



``` {r}
verwaltungsausgaben_aggregat <-verwaltungsausgaben %>%
  group_by(fj, gsrbetr) %>%
  summarise(vwausgaben = sum(soll)) %>%
  ungroup() %>%
  select(fj, vwausgaben, gsrbetr) #%>%
 # spread(fj, vwausgaben) %>%
  #mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
  #       avg15_17 = (`2015`+`2016`+`2017`)/3, 
  #       avg_diff = (avg15_17/avg12_14-1)*100)

verwaltungsausgaben_aggregat_sums <-verwaltungsausgaben_aggregat %>%
  spread(fj, vwausgaben) %>%
  mutate(vwausgabenvor = `2012`+`2014`+`2013`,
         vwausgabendanach = `2015`+`2016`+`2017`, 
         vwausgaben_vor_danach_diff = ((vwausgabendanach/vwausgabenvor)-1)*100)

needs(directlabels)
plot1 <- ggplot(verwaltungsausgaben_aggregat, aes(fj, vwausgaben, color = gsrbetr)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = gsrbetr), method="angled.boxes")+
  ylim(0, 400000000)

print(plot1)

verwaltungsausgaben_aggregat_avg_diff <- verwaltungsausgaben_aggregat %>%
  spread(fj, vwausgaben) %>%
  mutate(avgdiff_2011 = round((((`2011`/`2010`)-1)*100),2), 
         avgdiff_2012 = round((((`2012`/`2011`)-1)*100),2), 
         avgdiff_2013 = round((((`2013`/`2012`)-1)*100),2), 
         avgdiff_2014 = round((((`2014`/`2013`)-1)*100),2), 
         avgdiff_2015 = round((((`2015`/`2014`)-1)*100),2), 
         avgdiff_2016 = round((((`2016`/`2015`)-1)*100),2), 
         avgdiff_2017 = round((((`2017`/`2016`)-1)*100),2)) %>%
  gather(type, value, `2010`:avgdiff_2017) %>%
  separate(type, c("art", "fj"), sep="_") %>%
  na.omit(fj)

# Beim nächsten Mal so auflösen: verwaltungsausgaben_aggregat %>% mutate(fj_next=fj+1) %>% left_join(verwaltungsausgaben_aggregat, by=c('fj_next'='fj'))

plot14 <- ggplot(verwaltungsausgaben_aggregat_avg_diff, aes(x = fj, y= value, fill = gsrbetr))+
  geom_bar(stat = "identity")+
  facet_wrap(~gsrbetr)
plot(plot14)     

ggsave("output/ignore/plot11.pdf", device="pdf")

verwaltungsausgaben_aggregat_avg_diff_dw <- verwaltungsausgaben_aggregat_avg_diff %>%
  spread(fj, value)
write.xlsx(verwaltungsausgaben_aggregat_avg_diff_dw, "output/ignore/verwaltungsausgaben_aggregat_avg_diff_dw.xlsx", sheetName = "Vwsteigerung pro Kopf")


verwaltungsausgabenprokopf_gsrbetr <-verwaltungsausgaben %>%
  group_by(fj, gsrbetr) %>%
  summarise(vwausgaben = sum(soll)) %>%
  ungroup() %>%
  select(fj, vwausgaben, gsrbetr) 

# Kalkulieren der Bevölkerung für die Ja-Nein-Gsrbetr Gemeinden total 
gsrbetr_bev <- gemeinden_reg %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
  select(gkz_neu,jahr,ew) %>%
  group_by(gkz_neu, jahr) %>%
  left_join(gsr15, by=c("gkz_neu"="gkz"))

gsrbetr_bev_t <- gsrbetr_bev %>%
  group_by(gsrbetr, jahr) %>%
  summarise(ew = sum(ew)) 

# Join der Bevölkerung mit den Verwaltungsausgaben
verwaltungsausgabenprokopf_gsrbetr_t <- verwaltungsausgabenprokopf_gsrbetr %>%
  left_join(gsrbetr_bev_t, by=c("gsrbetr"="gsrbetr", "fj"="jahr")) %>%
  mutate(vwausgabenprokopf = vwausgaben/ew)

plot29 <- ggplot(verwaltungsausgabenprokopf_gsrbetr_t, aes(fj, vwausgabenprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = gsrbetr), method="angled.boxes")+
  ylim(0, 700)+
   theme_minimal()
plot(plot29) 
 
ggsave("output/ignore/plot29.pdf", device="pdf")

verwaltungsausgabenprokopf_gsrbetr_t_dw <- verwaltungsausgabenprokopf_gsrbetr_t %>%
  select(fj, gsrbetr, vwausgabenprokopf) %>%
  mutate(vwausgabenprokopf = round(vwausgabenprokopf, 0)) %>%
  spread(gsrbetr, vwausgabenprokopf)

verwaltungsausgabenprokopf_gsrbetr_t_dw_unrounded <- verwaltungsausgabenprokopf_gsrbetr_t %>%
  select(fj, gsrbetr, vwausgabenprokopf) %>%
  mutate(vwausgabenprokopf = vwausgabenprokopf) %>%
  spread(gsrbetr, vwausgabenprokopf)

write.xlsx(verwaltungsausgabenprokopf_gsrbetr_t_dw, "output/ignore/verwaltungsausgabenprokopf_gsrbetr_t_dw.xlsx", sheetName = "vw")

# Personenzahl nach Gemeindegrößenklasse und gsr-betr
gsrbetr_bev_gemgr <- verwaltungsausgaben %>%
  distinct(fj, gkz_neu, gemgrklas, ew, gsrbetr) %>%
  group_by(fj, gemgrklas, gsrbetr) %>%
  summarise(ew = sum(ew)) 

# Verwaltungsausgaben pro Kopf nach Gemeindegrößenklasse
verwaltungsausgabenprokopf_gemgrklas <-verwaltungsausgaben %>%
  group_by(fj, gsrbetr, gemgrklas) %>%
  summarise(vwausgaben = sum(soll)) %>%
  ungroup() %>%
  select(fj, vwausgaben, gemgrklas, gsrbetr) %>%
  left_join(gsrbetr_bev_gemgr, by=c("fj"="fj", "gemgrklas"="gemgrklas", "gsrbetr"="gsrbetr")) %>%
  group_by(fj, gemgrklas, gsrbetr) %>%
  summarise(vwausgaben = sum(vwausgaben), 
            ew = sum(ew)) %>%
  mutate(vwausgabenprokopf = vwausgaben/ew)

p <- ggplot(verwaltungsausgabenprokopf_gemgrklas, aes(x = fj, y = vwausgabenprokopf, color=gsrbetr, group=gsrbetr)) +
    geom_line(lwd=0.9) +
    facet_wrap(~gemgrklas)+
  theme_minimal()
plot(p)

```

```{r}

personalausgaben_absolut_gsrbetr_t <- personalausgaben_absolut %>%
  left_join(gsrbetr_bev_t, by=c("gsrbetr"="gsrbetr", "fj"="jahr")) %>%
  mutate(personalausgabeew = personalausgaben/ew)%>%
    select(fj, gsrbetr, personalausgabeew) %>%
    spread(gsrbetr, personalausgabeew)
 
  write.xlsx(personalausgaben_absolut_gsrbetr_t, "output/ignore/personalausgaben_absolut_gsrbetr_t.xlsx")
  
```

```{r message=FALSE, warning=FALSE}
verwaltungsausgaben_bev_vfgh <- verwaltungsausgaben %>%
  distinct(fj, gkz_neu, ew) %>%
  filter(gkz_neu %in% vfgh$gkz) %>%
  group_by(fj) %>%
  summarise(ew = sum(ew)) 
 
verwaltungsausgabenprokopf_vfgh <- verwaltungsausgaben %>%
  filter(gkz_neu %in% vfgh$gkz) %>%
  group_by(fj) %>%
  summarise(vwausgaben = sum(soll)) %>%
  left_join(verwaltungsausgaben_bev_vfgh, by = c("fj"="fj")) %>%
  mutate(vwausgabenprokopf = vwausgaben/ew, 
         gsrbetr = "Ja, VFGH")
 
test <- rbind(verwaltungsausgabenprokopf_gsrbetr_t, verwaltungsausgabenprokopf_vfgh)

plot7 <- ggplot(test, aes(fj, vwausgabenprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  #geom_dl(aes(label = gsrbetr), method="angled.boxes")+
  ylim(0, 700)
plot(plot7)

```


```{r}
# Wahlgeschichte
wahlen_bordermanned_t <- wahlen_bordermanned %>%
  left_join(gsr15, by=c("gkz"="gkz")) %>%
  filter(partei=="gültig" | partei =="ungültig" | partei=="Wahlberechtigte")%>%
  spread(partei, count) %>%
  mutate(beteiligte = gültig+ungültig)%>%
  group_by(jahr, wahl, gsrbetr) %>%
  summarise(beteiligte = sum(beteiligte), 
            wb = sum(Wahlberechtigte)) %>%
  mutate(wb_pct = beteiligte/wb*100) %>%
  select(jahr, wahl, gsrbetr, wb_pct) 

plot12 <- ggplot(wahlen_bordermanned_t, aes(jahr, y= wb_pct, color = gsrbetr)) +
  geom_bar(aes(fill = gsrbetr), position = "dodge", stat="identity")+
  facet_grid(~wahl)+
  theme_addendum()+
  theme(legend.position="none")
plot(plot12)

#Differenz kalkulieren
wahlbeteiligung <- wahlen_bordermanned_t %>%
  spread(jahr, wb_pct) 

#Herausschreiben für Datawrapper

```

```{r}
# Wie findet man eine Gemeinde, die höhere Verwaltungsausgaben und höhere Personalkosten hat und dagegen war? 

vw_pers_erhöhung <- verwaltungsausgabenprokopf %>%
  left_join(personalkostenprokopf %>% select(gkz_neu, avg_diff), by=c("gkz_neu"="gkz_neu")) %>%
  left_join(vfgh, by=c("gkz_neu"="gkz")) %>%
  rename( diff_vw = `avg_diff.x`, 
         diff_pers = `avg_diff.y`) %>%
  mutate(erh_index = (diff_vw+diff_pers)/2)
  

```


```{r}
# Nachfrage von Kathrein-Tragöß

kathrein <- verwaltungsausgaben %>%
  filter(gkz_neu=="62148")

write.xlsx(kathrein, "output/ignore/kathrein.xlsx")

```

```{r}
# Land Steiermark zweifelt die Ergebnisse an, Graz müsste aus Berechnung raus - wie sähe die Berechnung dann aus?
verwaltungsausgabenprokopf_gsrbetr_ls <-verwaltungsausgaben %>%
  #filter(gkz_neu!="60101") %>%
  group_by(fj, gsrbetr) %>%
  summarise(vwausgaben = sum(soll)) %>%
  ungroup() %>%
  select(fj, vwausgaben, gsrbetr) 

# Kalkulieren der Bevölkerung für die Ja-Nein-Gsrbetr Gemeinden total 
gsrbetr_bev_ls <- gemeinden_reg %>%
  filter(gkz_neu >60000 & gkz_neu < 70000) %>%
  #filter(gkz_neu != "60101") %>% # Graz rauswerfen
  select(gkz_neu,jahr,ew) %>%
  group_by(gkz_neu, jahr) %>%
  left_join(gsr15, by=c("gkz_neu"="gkz"))

# Bevölkerung in fusionierten/ nicht fusionierten berechnen
gsrbetr_bev_t_ls <- gsrbetr_bev_ls %>%
  group_by(gsrbetr, jahr) %>%
  summarise(ew = sum(ew)) 

# Join der Bevölkerung mit den Verwaltungsausgaben ohne Graz
verwaltungsausgabenprokopf_gsrbetr_t_ls <- verwaltungsausgabenprokopf_gsrbetr_ls %>%
  left_join(gsrbetr_bev_t_ls, by=c("gsrbetr"="gsrbetr", "fj"="jahr")) %>%
  mutate(vwausgabenprokopf = vwausgaben/ew)

# Zeichnen der Verwaltungsausgaben ohne Graz
plot30 <- ggplot(verwaltungsausgabenprokopf_gsrbetr_t_ls, aes(fj, vwausgabenprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = gsrbetr), method="angled.boxes")+
  ylim(0, 700)+
   theme_minimal()
plot(plot30) 

# Berechnen der prozentuellen Veränderung der pro Kopf Kosten ohne Graz nach fusioniert/ nicht fusioniert
verwaltungsausgaben_aggregat_avg_diff_ls <- verwaltungsausgabenprokopf_gsrbetr_t_ls %>%
  select(-c(ew, vwausgaben))%>%
  spread(fj, vwausgabenprokopf) %>%
  mutate(avgdiff_2011 = round((((`2011`/`2010`)-1)*100),2), 
         avgdiff_2012 = round((((`2012`/`2011`)-1)*100),2), 
         avgdiff_2013 = round((((`2013`/`2012`)-1)*100),2), 
         avgdiff_2014 = round((((`2014`/`2013`)-1)*100),2), 
         avgdiff_2015 = round((((`2015`/`2014`)-1)*100),2), 
         avgdiff_2016 = round((((`2016`/`2015`)-1)*100),2), 
         avgdiff_2017 = round((((`2017`/`2016`)-1)*100),2)) %>%
  gather(type, value, `2010`:avgdiff_2017) %>%
  separate(type, c("art", "fj"), sep="_") %>%
  na.omit(fj)

#write.xlsx(verwaltungsausgaben_aggregat_avg_diff_ls, "output/ignore/verwaltungsausgaben_aggregat_avg_diff_ls_ohneGraz.xlsx", sheetName = "Verwaltungsausgaben #absolut ohne Graz")
write.xlsx(verwaltungsausgaben_aggregat_avg_diff_ls, "output/ignore/verwaltungsausgaben_aggregat_avg_diff_ls_mitGraz.xlsx", sheetName = "Verwaltungsausgaben absolut mit Graz")



```

```{r}
# Land Steiermark zweifelt Ergebnisse an wegen Zu- bzw. Abwanderung aus Gemeinden. Berechnung der absoluten #Ausgaben ohne Berücksichtigung der Einwohnerzahl im ersten Schritt, festlegen einer fixen Einwohnerzahl im #zweiten Schritt. 

# Gesamtbetrag der Verwaltungsausgaben vor und nach der Fusion ohne Graz berechnen
verwaltungsausgaben_aggregat_ls <-verwaltungsausgaben %>%
 # filter(gkz_neu!="60101") %>%
  group_by(fj, gsrbetr) %>%
  summarise(vwausgaben = sum(soll)) %>%
  ungroup() %>%
  select(fj, vwausgaben, gsrbetr) %>%
  spread(fj, vwausgaben) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)

# verwaltungsausgaben_aggregat_sums_ls <-verwaltungsausgaben_aggregat_ls %>%
#   spread(fj, vwausgaben) %>%
#   mutate(vwausgabenvor = `2012`+`2014`+`2013`,
#          vwausgabendanach = `2015`+`2016`+`2017`, 
#          vwausgaben_vor_danach_diff = ((vwausgabendanach/vwausgabenvor)-1)*100)

verwaltungsausgaben_aggregat_ls_plot <- verwaltungsausgaben_aggregat_ls %>%
  select(-c(avg12_14, avg15_17, avg_diff)) %>%
  gather(fj, vwausgaben, `2010`:`2017`) %>%
  mutate(fj = as.numeric(fj))

plot100 <- ggplot(verwaltungsausgaben_aggregat_ls_plot, aes(fj, vwausgaben, color = gsrbetr)) +
  geom_line() +
  theme_addendum()+
  theme(legend.position="none")+
  geom_dl(aes(label = gsrbetr), method="angled.boxes")+
  ylim(0, 400000000)

print(plot100)

```

```{r}
# Betrachtung der absoluten Veärnderung je Gemeinde der Verwaltungsausgaben
verwaltungsausgaben_aggregat_ls_abs <-verwaltungsausgaben %>%
  group_by(fj, gsrbetr, gkz_neu) %>%
  summarise(vwausgaben = sum(soll)) %>%
  ungroup() %>%
  select(fj, vwausgaben, gsrbetr, gkz_neu) #%>%


# Mail an LH-Sprecher, Michael Feiertag
print(verwaltungsausgaben_aggregat_sums_ls_abs <-verwaltungsausgaben_aggregat_ls_abs %>%
  spread(fj, vwausgaben) %>%
  mutate(vwausgabenvor = `2012`+`2013`+`2014`,
         vwausgabendanach = `2016`+`2017`+`2015`, 
         vwausgaben_vor_danach_diff = ((vwausgabendanach/vwausgabenvor)-1)*100) %>%
  mutate(avg_diff_posneg = ifelse(vwausgaben_vor_danach_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
  spread(avg_diff_posneg, count) %>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0)))

# # Betrachtung der absoluten Veärnderung je Gemeinde der Verwaltungsausgaben
verwaltungsausgaben_aggregat_ls_abs_exp <-verwaltungsausgaben %>%
  group_by(fj, gsrbetr, gkz_neu) %>%
  summarise(vwausgaben = sum(soll)) %>%
  ungroup() %>%
  select(fj, vwausgaben, gsrbetr, gkz_neu) %>%
  spread(fj, vwausgaben)%>%
  left_join(gemeindenamen18, by=c("gkz_neu"="gkz_neu"))
write.xlsx(verwaltungsausgaben_aggregat_ls_abs_exp, "output/ignore/verwaltungsausgaben_aggregat_ls_abs_exp.xlsx", sheetName = "Verwaltungsausgaben absolut")

```



```{r}
# Check: Verwaltungsausgaben pro Kopf
verwaltungsausgabenprokopf_gsrbetr_t_dw_unrounded %>% left_join(verwaltungsausgabenprokopf_gsrbetr_t_dw_unrounded %>% mutate(fjl=fj+1), by=c('fj'='fjl')) %>% mutate(steiegerungja=round((Ja.x/Ja.y-1)*100,1), steigerungnein=round((Nein.x/Nein.y-1)*100,1)) %>% mutate(Ja.x=round(Ja.x,0), Nein.x=round(Nein.x,0)) %>% select(-Ja.y,-Nein.y)

```


```{r}
# Herausrechnen der Energiekosten für LH-Sprecher 
energiekoste_abs_ls <- posten_data %>%
  filter(gruppe=="Energie") %>% 
  filter (hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, name, gsrbetr, gruppe, ew) %>%
  summarise(energieausgaben = sum(soll)) %>%
  select(fj, gkz_neu, name, gsrbetr, energieausgaben) %>%
  ungroup() %>%
  spread(fj, energieausgaben) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)

print(energiekoste_abs_ls_summary_ls <- energiekoste_abs_ls %>%
  mutate(avg_diff_posneg = ifelse(avg_diff<=0, "sparen", "steigen")) %>%
  group_by(gsrbetr, avg_diff_posneg) %>%
  summarise(count = n()) %>%
    spread(avg_diff_posneg, count))%>%
  mutate(gesamt = sparen+steigen, 
         steigen_pct = round((steigen/gesamt*100),0))


energiekostenprokopf_ls_abs <- posten_data %>%
  filter(gruppe=="Energie") %>% 
  filter(hh=="1") %>%
  filter(gkz_neu >= 60000 & gkz_neu <70000) %>%
  group_by(fj, gkz_neu, gsrbetr, gruppe) %>%
  summarise(energieausgaben = sum(soll)) %>%
  select(fj, gsrbetr, energieausgaben) %>%
  ungroup() %>%
  spread(fj, energieausgaben) %>%
  mutate(avg12_14 = (`2012`+`2013`+`2014`)/3, 
         avg15_17 = (`2015`+`2016`+`2017`)/3, 
         avg_diff = (avg15_17/avg12_14-1)*100)

```

## Verwaltungsausgaben pro Kopf, mit konstanter Einwohnerzahl (Stand 2010)

```{r}
# Verwaltungsausgaben pro Kopf, aber bei schrumpfenden Gemeinden mit gleichbleibender Einwohnerzahl.
# Wie: Einwohnerzahl wird mindestens am Niveau von 2010 belassen.

verwaltungsausgaben_einwohner2010 <- verwaltungsausgaben %>%
  left_join(verwaltungsausgaben %>% filter(fj==2010) %>% select(gkz_neu, ew) %>% rename(ew2010=ew) %>% group_by(gkz_neu) %>% filter(row_number()==1), by='gkz_neu') %>%
  select(gkz_neu, fj, ew, ew2010, everything())

verwaltungsausgabenprokopf_einwohner2010 <- verwaltungsausgaben_einwohner2010 %>%
  group_by(fj, gkz_neu, name, gsrbetr, ew2010) %>%
  summarise(vwausgaben = sum(soll)) %>%
  mutate(vwausgabenprokopf = round(vwausgaben/ew2010,2))


plot_einwohner2010 <- ggplot(verwaltungsausgabenprokopf_einwohner2010 %>% group_by(fj, gsrbetr, gkz_neu) %>% summarise(vwausgaben=sum(vwausgaben), ew2010=first(ew2010)) %>% group_by(fj,gsrbetr) %>% summarise(vwausgabenprokopf=sum(vwausgaben)/sum(ew2010)), aes(fj, vwausgabenprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum() +
  ggtitle("VWA/Kopf Einwohnerzahl fix 2010")
  #theme(legend.position="none")+
  #geom_dl(aes(label = gsrbetr), method="angled.boxes")+plot(plot7)

plot(plot_einwohner2010)

verwaltungsausgaben_einwohner2010_diffs <- verwaltungsausgaben_einwohner2010 %>%
  group_by(fj, gkz_neu, name, gsrbetr, ew2010) %>%
  summarise(vwausgaben = sum(soll)) %>%
  mutate(vwausgabenprokopf = round(vwausgaben/ew2010,2)) %>%
  select(fj, gkz_neu, name, vwausgabenprokopf, gsrbetr) %>%
  spread(fj, vwausgabenprokopf) %>%
  mutate(avg12_14 = round((((`2012`+`2013`+`2014`)/3)),1),
         avg15_17 = round((((`2015`+`2016`+`2017`)/3)),1), 
         avg_diff = round((((avg15_17/avg12_14-1)*100)),1), 
         avg11_12 = round((((`2012`+`2011`)/2)),1), 
         avg16_17 = round((((`2016`+`2017`)/2)),1), 
         avg_diff_12_17 = round((((avg16_17/avg11_12-1)*100)),1))

ew2010_steigpct <- verwaltungsausgaben_einwohner2010_diffs %>%
  mutate(steigfall=case_when(avg_diff<=0 ~ 'fall', TRUE ~ 'steig')) %>%
  group_by(gsrbetr, steigfall) %>%
  summarise(n=n()) %>%
  spread(steigfall, n) %>%
  mutate(`Prozent Kostensteigerung` = steig/(fall+steig)*100) %>%
  select(-fall,-steig)


ew2010_steigpct_ohneausnahmejahre <- verwaltungsausgaben_einwohner2010_diffs %>%
  mutate(steigfall=case_when(avg_diff_12_17<=0 ~ 'fall', TRUE ~ 'steig')) %>%
  group_by(gsrbetr, steigfall) %>%
  summarise(n=n()) %>%
  spread(steigfall, n) %>%
  mutate(`Prozent Kostensteigerung ohne Ausnahmejahre` = steig/(fall+steig)*100) %>%
  select(-fall,-steig)

ew2010_steigpct %>% left_join(ew2010_steigpct_ohneausnahmejahre) %>%
  ungroup() %>%
  mutate(gsrbetr=case_when(gsrbetr == "Ja" ~ "Fusionsgemeinden", TRUE ~ "Nichtfusionsgemeinden"))
```


## Verwaltungsausgaben pro Kopf, mit bestmöglicher Einwohnerzahl für schrumpfende Gemeinden
Methodik: die Einwohnerzahl jeder Gemeinde wurde nach unten mit der Einwohnerzahl 2010 beschränkt

```{r}
# Verwaltungsausgaben pro Kopf, aber bei schrumpfenden Gemeinden mit gleichbleibender Einwohnerzahl.
# Wie: Einwohnerzahl wird mindestens am Niveau von 2010 belassen.

verwaltungsausgaben_einwohnerminimal <- verwaltungsausgaben %>%
  left_join(verwaltungsausgaben %>% filter(fj==2010) %>% select(gkz_neu, ew) %>% rename(ew2010=ew) %>% group_by(gkz_neu) %>% filter(row_number()==1), by='gkz_neu') %>%
  select(gkz_neu, fj, ew, ew2010, everything()) %>%
  mutate(ewmin=pmax(ew,ew2010)) %>%
  select(gkz_neu, fj, ew, ew2010, ewmin, everything()) %>%
  arrange(gkz_neu, fj, ew, ew2010, ewmin)

verwaltungsausgabenprokopf_einwohnerminimal <- verwaltungsausgaben_einwohnerminimal %>%
  group_by(fj, gkz_neu, name, gsrbetr, ew, ew2010, ewmin) %>%
  summarise(vwausgaben = sum(soll)) %>%
  mutate(vwausgabenprokopf = round(vwausgaben/ewmin,2))


plot_einwohnerminimal <- ggplot(verwaltungsausgabenprokopf_einwohnerminimal %>% group_by(fj, gsrbetr, gkz_neu) %>% summarise(vwausgaben=sum(vwausgaben), ewmin=first(ewmin)) %>% group_by(fj,gsrbetr) %>% summarise(vwausgabenprokopf=sum(vwausgaben)/sum(ewmin)), aes(fj, vwausgabenprokopf, color = gsrbetr)) +
  geom_line() +
  theme_addendum() +
  ggtitle("VWA/Kopf Einwohnerzahl mindestens 2010")

  #theme(legend.position="none")+
  #geom_dl(aes(label = gsrbetr), method="angled.boxes")+
plot(plot_einwohnerminimal)


verwaltungsausgaben_einwohnerminimal_diffs <- verwaltungsausgaben_einwohnerminimal %>%
  group_by(fj, gkz_neu, name, gsrbetr, ewmin) %>%
  summarise(vwausgaben = sum(soll)) %>%
  mutate(vwausgabenprokopf = round(vwausgaben/ewmin,2)) %>%
  select(fj, gkz_neu, name, vwausgabenprokopf, gsrbetr) %>%
  spread(fj, vwausgabenprokopf) %>%
  mutate(avg12_14 = round((((`2012`+`2013`+`2014`)/3)),1),
         avg15_17 = round((((`2015`+`2016`+`2017`)/3)),1), 
         avg_diff = round((((avg15_17/avg12_14-1)*100)),1), 
         avg11_12 = round((((`2012`+`2011`)/2)),1), 
         avg16_17 = round((((`2016`+`2017`)/2)),1), 
         avg_diff_12_17 = round((((avg16_17/avg11_12-1)*100)),1))

ewminimal_steigpct <- verwaltungsausgaben_einwohnerminimal_diffs %>%
  mutate(steigfall=case_when(avg_diff<=0 ~ 'fall', TRUE ~ 'steig')) %>%
  group_by(gsrbetr, steigfall) %>%
  summarise(n=n()) %>% spread(steigfall, n) %>%
  mutate(`Prozent Kostensteigerung` = steig/(fall+steig)*100) %>%
  select(-fall,-steig)



ewminimal_steigpct_ohneausnahmejahre <- verwaltungsausgaben_einwohnerminimal_diffs %>%
  mutate(steigfall=case_when(avg_diff_12_17<=0 ~ 'fall', TRUE ~ 'steig')) %>%
  group_by(gsrbetr, steigfall) %>%
  summarise(n=n()) %>%
  spread(steigfall, n) %>%
  mutate(`Prozent Kostensteigerung ohne Ausnahmejahre`=steig/(fall+steig)*100) %>%
  select(-fall,-steig)

ewminimal_steigpct %>% left_join(ewminimal_steigpct_ohneausnahmejahre) %>%
  ungroup() %>%
  mutate(gsrbetr=case_when(gsrbetr == "Ja" ~ "Fusionsgemeinden", TRUE ~ "Nichtfusionsgemeinden"))
```



```{r}
    env=new.env() #create a new empty environment, it inherits objects from the current environment.
    rmarkdown::render('main_fragebogen_lhs.Rmd', output_file="fragebogen_lhs.html", envir = env, output_dir="output/generated")

```
```{r}


```


## Linting

The code in this RMarkdown is listed with the [lintr package](https://github.com/jimhester/lintr), which is based on the  [tidyverse style guide](http://style.tidyverse.org/). 

```{r echo=TRUE, message=FALSE, warning=FALSE}
lintr::lint("main.Rmd")
# if you have additional scripts and want them to be linted too, add them here
```


